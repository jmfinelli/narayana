name: Cleanup PR workflow runs

on:
  pull_request:
    types: [closed]

permissions:
  actions: write
  contents: read
  pull-requests: read

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Delete workflow runs for this PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "üîç Target repository: $REPO"
          echo "üîç Filtering by PR number: #$PR_NUMBER"

          # Get PR head branch name (same as your script)
          HEAD_BRANCH=$(gh pr view "$PR_NUMBER" \
            --repo "$REPO" \
            --json headRefName \
            -q .headRefName)

          if [ -z "$HEAD_BRANCH" ]; then
            echo "‚ùå Could not determine head branch for PR #$PR_NUMBER"
            exit 1
          fi

          echo "üìé PR #$PR_NUMBER is from branch '$HEAD_BRANCH'"
          echo "Fetching workflow runs..."

          while true; do
            RUN_IDS=$(gh run list \
              --repo "$REPO" \
              --limit 100 \
              --json databaseId,event,headBranch \
              -q ".[]
                  | select(.event == \"pull_request\")
                  | select(.headBranch == \"$HEAD_BRANCH\")
                  | .databaseId")

            if [ -z "$RUN_IDS" ]; then
              echo "‚úÖ No runs to delete."
              break
            fi

            echo "$RUN_IDS" | while read -r RUN_ID; do
              if [ -n "$RUN_ID" ]; then
                echo "üóëÔ∏è  Deleting run ID: $RUN_ID"
                gh run delete "$RUN_ID" --repo "$REPO" --yes || true
              fi
            done
          done
